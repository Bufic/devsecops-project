// 




pipeline {
    agent none  // No agent is used by default

    environment {
        REGISTRY = 'ghcr.io'
        IMAGE_NAME = "bufic/devsecops-project"
        KUBE_CONTEXT = "kind-tic-tac-cluster"  // Replace with your Kind cluster context
    }

    stages {
        stage('Checkout Code') {
            steps {
                node {
                    checkout scm  // Automatically checks out the code from the Git repository
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                node {
                    sh 'npm ci'  // Install dependencies using clean install
                }
            }
        }

        stage('Unit Testing') {
            steps {
                node {
                    sh 'npm test'  // Run unit tests
                }
            }
        }

        stage('Static Code Analysis') {
            steps {
                node {
                    sh 'npm run lint'  // Run linting for static code analysis
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                node {
                    script {
                        def imageTag = "sha-${env.GIT_COMMIT}"  // Use the Git commit hash as the image tag
                        def fullImageName = "${REGISTRY}/${IMAGE_NAME}:${imageTag}"

                        sh """
                            docker build -t ${fullImageName} .
                            docker push ${fullImageName}
                            kind load docker-image ${fullImageName} --name tic-tac-cluster
                        """
                    }
                }
            }
        }

        stage('Update Kubernetes Deployment') {
            steps {
                node {
                    script {
                        def imageTag = "sha-${env.GIT_COMMIT}"
                        def newImage = "${REGISTRY}/${IMAGE_NAME}:${imageTag}"

                        sh """
                            sed -i "s|image: ${REGISTRY}/.*|image: ${newImage}|g" kubernetes/deployment.yaml
                            echo "Updated deployment to use image: ${newImage}"
                        """
                    }
                }
            }
        }

        stage('Deploy to Kind') {
            steps {
                node {
                    script {
                        sh """
                            kubectl config use-context ${KUBE_CONTEXT}
                            kubectl apply -f kubernetes/deployment.yaml
                        """
                    }
                }
            }
        }
    }

    post {
        always {
            node {
                sh 'docker system prune -f'  // Clean up Docker resources
            }
        }
    }
}